#!/bin/bash
# surrogate
# loren carvalho, 2012
count=0

# empty vars on initial call, can reuse init() if needed
init() {
	type=""
	restore=""
	promote=""
}

rebuild_configs_for_instance() {
	instance=$1
	echo "REBUILDING CONFIGS FOR $instance"
	mysql_data_path="$original_data_path/$instance"
	backup_directory="$original_backup_dir/$instance"
	mysql_collapse_path="$original_collapse_path/$instance"
	mysql_sanity_path="$original_sanity_path/$instance"
	inc_backup_path="$backup_directory/$today/inc_$now"
	last_backup=`tail -n1 $backup_directory/.digest`
	restore="$backup_directory/.digest"
}

# explain the usage
usage() { 
cat <<-EOF
	usage: $0 options

	This script must be run with sudo or as root, 
  it also expects some arguments, please oblige!

	OPTIONS:

	-h	Shows this message
	-b	Backup, either incremental or full, 
      "surrogate -b full", "surrogate -b inc", or "surrogate -b dump" for mysqldump
	-r 	Restore using default digest location (only for backups made using full or inc.)
	-c 	Restore, accepts a file containing a list of directories to restore.
	
EOF
exit 1
}

function determine_full_backup_path(){
  # determine the location of todays backup (for retention)
  if [[ `date +%d` == "01" ]];
    then
        full_backup_path="$backup_directory/monthly/full_$now"
  elif [[ `date +%u` == "7" ]];
    then
        full_backup_path="$backup_directory/weekly/full_$now"
  else
        full_backup_path="$backup_directory/daily/`date +%a`/full_$now"
  fi
}

# if there is no input, barf
test $# -ge 1 || usage
set -u
# make sure ran as root and check prereqs
test `whoami` == "root" || { echo "Neet to run as root!"; exit 1; }
{ which innobackupex && which rsync; } &>/dev/null || { echo "Prereqs not met! Make sure you have rsync and percona-xtrabackup installed."; exit 1; }

# read configs
source /etc/surrogate/surrogate.conf
source /etc/surrogate/xtrabackup.conf
source $my_root/lib/rotate

# recursive?
#source <libdir>/surrogate

init

# rotate if desired
$auto_rotate && rotate_backups

# get input
while getopts "hb:rc:" option 
do
  case $option in
  h)
    usage
  ;;
  b)
    type=$OPTARG
    if [[ "$type" == "full" ]]; then
      source $my_root/lib/full
    elif [[ "$type" == "inc" ]]; then
      source $my_root/lib/inc
    elif [[ "$type" == "dump" ]]; then
      source $my_root/lib/dump	
    else
      echo "Please specify full or incremental"
      usage
    fi
  ;;
  r)
    source $my_root/lib/restore
  ;;
  c)
    restore=$OPTARG
    source $my_root/lib/restore
  ;;
  esac
done

for instance in $mysql_instances; do
  count=`expr $count + 1` 
done

# Check vars & perform the loaded action
if [ $count -gt 1 ]; then
  original_data_path=$mysql_data_path
  original_backup_dir=$backup_directory
  original_collapse_path=$mysql_collapse_path
  original_sanity_path=$mysql_sanity_path

  for instance in $mysql_instances; do
    echo "Processing instance: $instance"
    rebuild_configs_for_instance $instance
    perform_action $instance
  done
else
  socket=$mysql_socket
  perform_action $mysql_instances
fi

# fin
